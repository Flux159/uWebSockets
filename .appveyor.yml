
# image: Visual Studio 2015

# Nodejs 8.x installed with Visual Studio 2015 by default
environment:
  nodejs_version: "8"

# Only build for x64, other option could be -x86
platform:
  - x64

shallow_clone: true

# Install vcpkg and install dependencies
install:
  - cmd: git clone https://github.com/Microsoft/vcpkg.git
  - cmd: cd vcpkg
  - cmd: .\bootstrap-vcpkg.bat
  - cmd: .\vcpkg integrate install
  - cmd: vcpkg install openssl zlib libuv

# Use buildscript instead of default msbuild
build: off

# Make
build_script:
  - cmd: cd %APPVEYOR_BUILD_FOLDER%
  - cmd: cd .\nodejs
  - cmd: make.bat
  - cmd: cd ..

# Deploy to github: See docs: https://www.appveyor.com/docs/deployment/github/
# Note: The auth_token: secure: is NOT the raw github api token. It is the encrptyed 
# token generated by appveyor's encrypt data tool: https://ci.appveyor.com/tools/encrypt
# See the docs for more information: https://www.appveyor.com/docs/how-to/git-push/
# Note that when creating a token in github, only public_repo access is needed
artifacts:
  - path: nodejs\dist\*.node
    name: windowsbinaries

deploy:
  provider: GitHub
  auth_token:
    secure: tNG9L5Q3V6WFifc1nlTplAKJPd6Xyk/y/yZ6WimLXtBwUUm3oX4LUmg3qZdkUUDF
  artifact: windowsbinaries
  on:
    appveyor_repo_tag: true 

# Note: Workflow for appveyor: 
# git push # Push changes to master, run CI, make sure it works & passes all tests
# git tag -a v0.20.0 -m 'Version 0.20.0'
# git push --tags # Push tags independently after push to master, run CI and deploy
